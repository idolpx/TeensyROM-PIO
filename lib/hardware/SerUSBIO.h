// MIT License
// 
// Copyright (c) 2023 Travis Smith
// 
// Permission is hereby granted, free of charge, to any person obtaining a copy of this software 
// and associated documentation files (the "Software"), to deal in the Software without 
// restriction, including without limitation the rights to use, copy, modify, merge, publish, 
// distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom 
// the Software is furnished to do so, subject to the following conditions:
// 
// The above copyright notice and this permission notice shall be included in all copies or 
// substantial portions of the Software.
// 
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING 
// BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND 
// NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, 
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, 
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

#ifndef SERUSBIO_H
#define SERUSBIO_H

#include <Arduino.h>

#include "Menu_Regs.h"

#ifdef Dbg_SerSwift
   //RxIn 497+551=1048
   //big 8-bit playground buffer for testing
  PROGMEM const uint8_t TestBuf[] ={
      168,168,168,168,168,168,168,168,168,168,168,168,168,168,168,168,168,168,168,168,168,168,168,168,168,168,168,168,168,168,13,32,32,
      18,28,220,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,162,162,162,32,172,162,162,162,172,162,162,162,
      187,32,44,146,166,13,32,32,18,220,32,32,161,146,223,18,32,32,32,32,162,146,169,18,32,172,161,32,146,223,18,32,
      146,161,18,152,190,153,162,30,188,28,161,146,161,18,32,150,162,129,188,146,32,18,154,32,156,32,5,32,28,161,206,223,
      146,13,32,32,18,220,146,190,18,162,146,158,58,46,28,184,188,183,158,58,46,58,28,188,32,158,46,18,28,162,146,158,
      58,32,28,190,18,153,187,146,30,162,18,151,172,146,129,172,28,187,18,150,32,146,129,162,18,31,172,146,32,156,187,18,
      5,32,146,156,172,18,28,190,180,146,219,165,13,32,32,18,156,220,163,163,163,163,163,163,163,163,163,163,163,163,163,163,
      163,163,146,161,18,30,32,146,32,18,129,32,146,28,188,150,190,18,129,32,146,32,18,154,32,5,161,146,161,18,152,32,
      156,161,167,175,175,146,13,32,32,18,220,32,220,32,32,32,32,32,32,32,32,32,32,46,32,32,32,188,146,151,188,18,
      129,162,146,28,190,18,156,190,146,161,18,31,162,154,162,146,156,190,5,188,151,190,18,162,154,161,172,31,190,146,220,13,
      32,32,154,188,18,185,185,185,185,168,175,175,175,164,164,164,164,39,185,185,185,185,185,185,185,185,164,175,175,175,175,185,
      185,185,146,156,184,31,168,59,13,32,32,151,167,18,31,32,32,32,32,163,163,220,163,183,183,183,183,184,32,32,32,32,
      32,166,220,32,183,163,163,163,163,168,32,32,32,168,146,151,165,13,32,32,167,18,5,32,32,146,161,18,32,31,32,32,
      5,190,32,167,32,31,32,5,32,31,32,5,190,32,167,32,32,31,32,5,190,32,188,165,31,32,5,167,32,31,166,5,
      167,32,32,188,146,151,165,13,32,32,167,18,5,32,31,163,5,167,32,31,32,32,5,32,31,163,5,167,32,31,32,5,
      32,31,32,5,32,31,44,163,5,32,31,163,5,167,32,31,163,5,167,32,31,32,5,167,32,146,187,18,167,32,31,163,
      5,32,146,151,165,13,32,32,170,18,5,32,31,32,5,167,32,31,32,32,5,32,31,166,5,167,187,32,172,31,32,5,
      32,31,33,32,5,32,31,32,5,167,32,31,32,5,167,32,31,58,5,167,32,32,167,32,31,166,5,32,146,151,165,13,
      32,32,167,18,5,32,32,146,190,18,32,31,166,32,5,32,32,167,31,182,5,32,31,32,32,5,32,146,182,18,182,32,
      32,146,161,18,32,31,46,5,167,32,31,32,5,167,32,146,188,18,167,32,31,161,5,32,146,151,165,13,32,32,167,18,
      5,32,146,31,166,18,166,5,32,146,31,58,18,166,5,32,146,31,33,18,5,32,146,31,221,18,5,32,31,187,166,5,
      32,31,46,5,167,32,31,166,5,167,32,31,187,5,167,32,31,172,5,167,32,146,31,58,18,5,167,32,146,31,39,18,
      5,32,146,151,165,13,32,32,167,18,5,32,146,31,33,166,18,5,32,32,170,32,146,31,58,18,5,32,146,31,33,18,
      5,32,146,32,18,31,182,5,32,32,167,32,146,32,18,167,187,32,172,146,188,18,32,146,190,18,32,146,151,164,18,5,
      167,32,32,172,146,151,165,13,32,32,32,163,163,163,152,172,187,151,163,163,163,163,163,152,191,151,163,163,18,152,191,146,
      151,163,163,163,163,163,152,191,18,191,146,151,163,163,163,163,163,152,172,18,32,146,187,151,163,163,13,32,32,32,32,172,
      18,162,162,152,162,162,146,187,32,32,151,172,18,172,32,152,32,187,146,187,32,32,18,151,190,187,162,152,162,172,188,146,
      32,32,151,172,18,172,32,152,187,146,187,13,32,32,32,32,18,149,161,146,151,185,18,188,190,146,152,185,161,32,32,18,
      149,172,151,32,32,32,152,32,187,146,32,32,18,151,172,32,32,32,152,32,187,146,32,32,32,18,151,187,185,172,146,13,
      32,32,32,32,32,18,149,191,146,32,32,151,191,32,32,32,32,18,149,188,146,32,32,18,151,190,146,32,32,32,149,190,
      18,190,151,162,162,188,146,152,188,32,32,32,18,149,191,151,32,146,191,13,13,32,32,32,195,85,82,82,69,78,84,76,
      89,32,68,79,87,78,32,70,79,82,32,77,65,73,78,84,69,78,65,78,67,69,44,13,32,32,32,32,32,32,80,76,
      69,65,83,69,32,67,65,76,76,32,66,65,67,75,32,76,65,84,69,82,46,13,13,13,13,13,13
   };
#endif

extern Stream *CmdChannel;

#ifdef FeatTCPListen
#include <NativeEthernet.h>
extern EthernetServer tcpServer;
extern bool NetListenEnable;
FLASHMEM void ServiceTCP(EthernetClient &tcpclient);
#endif

FLASHMEM void ServiceSerial(Stream *ThisCmdChannel = &Serial);
FLASHMEM void AddAndCheckSource(StructMenuItem SourceMenu, uint32_t *TotalSize, uint32_t *FileCount);
FLASHMEM void GetDigits(uint8_t NumDigits, uint32_t *SetInt);
FLASHMEM void PrintDebugLog();
FLASHMEM void LaunchFile();
FLASHMEM bool ReceiveFileName(RegMenuTypes *DriveType, char *FileNamePath);
FLASHMEM bool GetUInt(uint32_t *InVal, uint8_t NumBytes);
FLASHMEM void SendU16(uint16_t SendVal);
FLASHMEM void SendU32(uint32_t SendVal);
FLASHMEM bool SerialAvailabeTimeout();
uint32_t RAM2BytesFree();

//memory info display via:
// https://forum.pjrc.com/threads/33443-How-to-display-free-ram
// https://www.pjrc.com/store/teensy41.html#memory

#if ARDUINO_TEENSY41
  extern "C" uint8_t external_psram_size;
#endif
  
FLASHMEM void memInfo ();
FLASHMEM void  getFreeITCM();

#endif // SERUSBIO_H